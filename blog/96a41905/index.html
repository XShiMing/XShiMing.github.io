<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>SpringCloud | 失铭的学习笔记</title><meta name="keywords" content="Spring,SpringCloud"><meta name="author" content="失铭"><meta name="copyright" content="失铭"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="本博客练习项目已上传gitee-&gt;失铭&#x2F;SpringCloud练习  微服务概述什么是微服务 引用ThoughtWorks 公司的首席科学家 Martin Fowler Microservices 文中的介绍  In short, the microservice architectural style is an approach to developing a single appli">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud">
<meta property="og:url" content="https://shiming.best/blog/96a41905/index.html">
<meta property="og:site_name" content="失铭的学习笔记">
<meta property="og:description" content="本博客练习项目已上传gitee-&gt;失铭&#x2F;SpringCloud练习  微服务概述什么是微服务 引用ThoughtWorks 公司的首席科学家 Martin Fowler Microservices 文中的介绍  In short, the microservice architectural style is an approach to developing a single appli">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200821223213.png">
<meta property="article:published_time" content="2020-08-20T08:46:56.000Z">
<meta property="article:modified_time" content="2020-08-22T16:00:00.000Z">
<meta property="article:author" content="失铭">
<meta property="article:tag" content="Spring">
<meta property="article:tag" content="SpringCloud">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200821223213.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://shiming.best/blog/96a41905/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-08-23 00:00:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="失铭的学习笔记" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/null" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">60</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">39</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div></div></div><hr/></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200821223213.png)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">失铭的学习笔记</a></span><span id="menus"><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">SpringCloud</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-08-20T08:46:56.000Z" title="发表于 2020-08-20 16:46:56">2020-08-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-08-22T16:00:00.000Z" title="更新于 2020-08-23 00:00:00">2020-08-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Spring/">Spring</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Spring/SpringCloud/">SpringCloud</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>本博客练习项目已上传gitee-&gt;<a target="_blank" rel="noopener" href="https://gitee.com/xshiming/spring-cloud-exercise.git">失铭/SpringCloud练习</a></p>
</blockquote>
<h2 id="微服务概述"><a href="#微服务概述" class="headerlink" title="微服务概述"></a>微服务概述</h2><h3 id="什么是微服务"><a href="#什么是微服务" class="headerlink" title="什么是微服务"></a>什么是微服务</h3><blockquote>
<p>引用ThoughtWorks 公司的首席科学家 Martin Fowler <a target="_blank" rel="noopener" href="https://martinfowler.com/articles/microservices.html">Microservices</a> 文中的介绍</p>
</blockquote>
<p>In short, the microservice architectural style is an approach to developing a single application as a suite of small services, each running in its own process and communicating with lightweight mechanisms, often an HTTP resource API. These services are built around business capabilities and independently deployable by fully automated deployment machinery. There is a bare minimum of centralized management of these services, which may be written in different programming languages and use different data storage technologies.</p>
<p>谷歌翻译如下：</p>
<p>简而言之，微服务架构样式是一种将单个应用程序开发为一组小服务的方法，每个小服务都在自己的进程中运行并与轻量级机制（通常是HTTP资源API）进行通信。这些服务围绕业务功能构建，并且可以由全自动部署机制独立部署。这些服务的集中管理几乎没有，可以用不同的编程语言编写并使用不同的数据存储技术。</p>
<p>单体架构和微服务：</p>
<p><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200818212922.png" alt="20200818212922"></p>
<p>微服务架构风格中以构建一组小型服务的方式来构建应用系统。这些服务除了能被独立地部署和扩展之外，每一个服务还能提供一个稳固的模块边界，甚至能允许使用不同的编程语言来编写不同的服务。这些服务也能被不同的团队来管理。</p>
<p>每一个功能元素最终都是一个可独立替换和独立升级的软件单元。</p>
<h3 id="微服务优缺点"><a href="#微服务优缺点" class="headerlink" title="微服务优缺点"></a>微服务优缺点</h3><p><strong>优点：</strong></p>
<ul>
<li>每个服务足够内聚，足够小，代码容易理解，能<strong>聚焦</strong>一个指定的业务功能或业务需求。</li>
<li>开发简单，<strong>开发效率高</strong>，一个服务可能只需要干一件事。</li>
<li>微服务能够被<strong>小团队</strong>单独开发（2-5人）。</li>
<li>易与第三方集成，微服务允许容易且灵活的方式集成自动部署</li>
<li>微服务易于被一个开发人员理解，修改和维护，这样小团队能够更关注自己的工作成果。无需通过合作才能体现价值。</li>
<li><strong>解耦</strong>：微服务是松耦合的，是有功能意义的服务，无论是在开发阶段还是部署阶段都是独立的</li>
<li>微服务能适用<strong>不同语言开发</strong></li>
<li>微服务<strong>只是业务逻辑的代码</strong>，不会和HTML,CSS 或其他界面组件混合。</li>
<li>每个微服务有<strong>自己的存储能力</strong>，它可以有自己的数据库，也可以有统一的数据库</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>分布式部署，调用复杂性<br>单体应用的时候，所有模块之前的调用都是在本地进行的，在微服务中，每个模块都是独立部署的，通过 HTTP 来进行通信，这当中会产生很多问题，比如网络问题、容错问题、调用关系等。</li>
<li>多服务运维难度</li>
<li>系统部署依赖</li>
<li>服务间通信成本</li>
<li>数据一致性</li>
<li>系统集成测试</li>
<li>性能监控</li>
</ul>
<h3 id="微服务技术栈"><a href="#微服务技术栈" class="headerlink" title="微服务技术栈"></a>微服务技术栈</h3><table>
<thead>
<tr>
<th align="center">微服务条目</th>
<th align="center">落地技术</th>
</tr>
</thead>
<tbody><tr>
<td align="center">服务开发</td>
<td align="center">SpringBoot、Spring、SpringMVC</td>
</tr>
<tr>
<td align="center">服务配置与管理</td>
<td align="center">Netflix公司的Archaius、阿里的Diamind等</td>
</tr>
<tr>
<td align="center">服务注册与发现</td>
<td align="center">Eureka、Consul、Zookeeper等</td>
</tr>
<tr>
<td align="center">服务调用</td>
<td align="center">Rest、RPC、gRPC</td>
</tr>
<tr>
<td align="center">服务熔断器</td>
<td align="center">Hystrix、Envoy等</td>
</tr>
<tr>
<td align="center">负载均衡</td>
<td align="center">Ribbon、Nginx等</td>
</tr>
<tr>
<td align="center">服务接口调用(客户端调用服务的简化工具)</td>
<td align="center">Feign等</td>
</tr>
<tr>
<td align="center">消息队列</td>
<td align="center">Kafka、RabbitMQ、ActiveMQ等</td>
</tr>
<tr>
<td align="center">服务配置中心管理</td>
<td align="center">SpringCloudConfig、Chef等</td>
</tr>
<tr>
<td align="center">服务路由(API网关)</td>
<td align="center">Zuul等</td>
</tr>
<tr>
<td align="center">服务监控</td>
<td align="center">Zabbix、Nagios、Metrics、Spectator</td>
</tr>
<tr>
<td align="center">全链路追踪</td>
<td align="center">Zipkin、Brave、Dapper等</td>
</tr>
<tr>
<td align="center">服务部署</td>
<td align="center">Docker、OpernStack、Kubernetes</td>
</tr>
<tr>
<td align="center">数据流操作开发包</td>
<td align="center">SpringCloud Stream(封装与Redis,Rabbit,Kafaka等发送接收消息)</td>
</tr>
<tr>
<td align="center">事件消息总线</td>
<td align="center">Spring Cloud Bus</td>
</tr>
</tbody></table>
<h2 id="Spring-Cloud"><a href="#Spring-Cloud" class="headerlink" title="Spring Cloud"></a>Spring Cloud</h2><blockquote>
<p>Spring Cloud是一系列框架的有序集合。它利用Spring Boot的开发便利性巧妙地简化了分布式系统基础设施的开发，如<strong>服务发现注册、配置中心、消息总线、负载均衡、断路器、数据监控</strong>等，都可以用Spring Boot的开发风格做到一键启动和部署。<br>Spring Cloud并没有重复制造轮子，它只是将各家公司开发的比较成熟、经得起实际考验的服务框架组合起来，通过Spring Boot风格进行再封装屏蔽掉了复杂的配置和实现原理，<strong>最终给开发者留出了一套简单易懂、易部署和易维护的分布式系统开发工具包。</strong></p>
</blockquote>
<p>SpringCloud是分布式微服务下的一站式解决方案，是各个微服务架构落地技术的集合体，俗称微服务全家桶</p>
<h3 id="Spring-Cloud-版本"><a href="#Spring-Cloud-版本" class="headerlink" title="Spring Cloud 版本"></a>Spring Cloud 版本</h3><p>Spring Cloud是一个由众多独立子项目组成的大型综合项目，每个子项目有不同的发行节奏，都维护着自己的发布版本号。Spring Cloud通过一个资源清单BOM（Bill of Materials）来管理每个版本的子项目清单。为避免与子项目的发布号混淆，所以没有采用版本号的方式，而是通过命名的方式。</p>
<p>这些版本名称的命名方式采用了伦敦地铁站的名称，同时根据字母表的顺序来对应版本时间顺序，比如：最早的Release版本：Angel，第二个Release版本：Brixton，然后是Camden、Dalston、Edgware，当前稳定版为Hoxton SR7。</p>
<p>当一个版本的Spring Cloud项目的发布内容积累到临界点或者解决了一个严重bug后，就会发布一个“service releases”版本，简称SRX版本，其中X是一个递增数字。</p>
<h3 id="SpringBoot和SpringCloud关系"><a href="#SpringBoot和SpringCloud关系" class="headerlink" title="SpringBoot和SpringCloud关系"></a>SpringBoot和SpringCloud关系</h3><ul>
<li><strong>SpringBoot专注于快速、方便的开发单个微服务个体，SpringCloud关注全局的服务治理框架。</strong></li>
<li>SpringCloud是关注全局的微服务协调整理治理框架，它将SpringBoot开发的一个个单体微服务整合并管理起来，为各个服务之间提供，配置管理、服务发现、断路器、路由、微代理、事件总线、全局锁、精选决策、分布式会话等集成服务。</li>
<li>SpringBoot可以离开SpringCloud独立开发项目，但是SpringCloud离不开SpringBoot，属于依赖关系。</li>
<li>Spring Boot 是 Spring 的一套快速配置脚手架，可以基于Spring Boot 快速开发单个微服务，Spring Cloud是一个基于Spring Boot实现的云应用开发工具。</li>
</ul>
<p><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200823101126.png" alt="20200823101126"></p>
<ul>
<li>API：API网关</li>
<li>Config server：云配置</li>
<li>Service registry：注册中心</li>
<li>Microservices：微服务</li>
<li>Distrubuted tracing：追踪</li>
</ul>
<h2 id="Dubbo"><a href="#Dubbo" class="headerlink" title="Dubbo"></a>Dubbo</h2><p>Apache Dubbo |ˈdʌbəʊ| 是一款高性能、轻量级的开源Java RPC框架，它提供了三大核心能力：面向接口的远程方法调用，智能容错和负载均衡，以及服务自动注册和发现。</p>
<p>Dubbo核心组件：</p>
<ul>
<li>Provider：暴露服务的提供方，可以通过 jar 或者容器的方式启动服务。</li>
<li>Consumer：调用远程服务的服务消费方</li>
<li>Registry：服务注册中和发现中心</li>
<li>Monitor：统计服务和调用次数，调用时间监控中心。（Dubbo 的控制台页面中可以显示，目前只有一个简单版本。）</li>
<li>Container：服务运行的容器。</li>
</ul>
<p><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200823100704.png" alt="20200823100704"></p>
<h3 id="Dubbo和SpringCluod区别"><a href="#Dubbo和SpringCluod区别" class="headerlink" title="Dubbo和SpringCluod区别"></a>Dubbo和SpringCluod区别</h3><table>
<thead>
<tr>
<th align="center">Dubbo</th>
<th align="center">SpringCloud</th>
<th align="center"></th>
</tr>
</thead>
<tbody><tr>
<td align="center">服务注册中心</td>
<td align="center">Zookeeper</td>
<td align="center">Spring Cloud Netfix Eureka</td>
</tr>
<tr>
<td align="center">服务调用方式</td>
<td align="center">RPC</td>
<td align="center">REST API</td>
</tr>
<tr>
<td align="center">服务监控</td>
<td align="center">Dubbo-monitor</td>
<td align="center">Spring Boot Admin</td>
</tr>
<tr>
<td align="center">熔断器</td>
<td align="center">不完善</td>
<td align="center">Spring Cloud Netflix Hystrix</td>
</tr>
<tr>
<td align="center">服务网关</td>
<td align="center">无</td>
<td align="center">Spring Cloud Netflix Zuul</td>
</tr>
<tr>
<td align="center">分布式配置</td>
<td align="center">无</td>
<td align="center">Spring Cloud Config</td>
</tr>
<tr>
<td align="center">服务跟踪</td>
<td align="center">无</td>
<td align="center">Spring Cloud Sleuth</td>
</tr>
<tr>
<td align="center">数据流</td>
<td align="center">无</td>
<td align="center">Spring Cloud Stream</td>
</tr>
<tr>
<td align="center">批量任务</td>
<td align="center">无</td>
<td align="center">Spring Cloud Task</td>
</tr>
<tr>
<td align="center">信息总线</td>
<td align="center">无</td>
<td align="center">Spring Cloud Bus</td>
</tr>
</tbody></table>
<div class="note info flat"><p>注意：Dubbo对于上表中总结为“无”的组件不代表不能实现，而只是Dubbo框架自身不提供，需要另外整合以实现对应的功能。</p>
</div>

<p>整体比较：</p>
<ol>
<li>dubbo由于是二进制的传输，占用带宽会更少</li>
<li>springCloud是http协议传输，带宽会比较多，同时使用http协议一般会使用JSON报文，消耗会更大</li>
<li>dubbo的开发难度较大，原因是dubbo的jar包依赖问题很多大型工程无法解决</li>
<li>springcloud的接口协议约定比较自由且松散，需要有强有力的行政措施来限制接口无序升级</li>
<li>dubbo的注册中心可以选择zk,redis等多种，springcloud的注册中心只能用eureka或者自研</li>
</ol>
<div class="note info flat"><ul>
<li>Dubbo 只是实现了服务治理，而 Spring Cloud 子项目分别覆盖了微服务架构下的众多部件，服务治理只是其中的一个方面。</li>
<li>Dubbo的定位是一款RPC框架，Spring Cloud的目标是微服务架构下的一站式解决方案。</li>
</ul>
</div>

<h2 id="Zureka"><a href="#Zureka" class="headerlink" title="Zureka"></a>Zureka</h2><p>Eureka是Netflix开发的服务发现框架，本身是一个基于REST的服务，主要用于定位运行在AWS域中的中间层服务，以达到负载均衡和中间层服务故障转移的目的。<br>SpringCloud将它集成在其子项目spring-cloud-netflix中，以实现SpringCloud的服务发现功能。</p>
<p>Eureka包含两个组件：Eureka Server和Eureka Client。</p>
<ul>
<li>Eureka Server提供服务注册服务，各个节点启动后，会在Eureka Server中进行注册，这样EurekaServer中的服务注册表中将会存储所有可用服务节点的信息，服务节点的信息可以在界面中直观的看到。</li>
<li>Eureka Client是一个java客户端，用于简化与Eureka Server的交互，客户端同时也就是一个内置的、使用轮询(round-robin)负载算法的负载均衡器。<br>在应用启动后，将会向Eureka Server发送心跳,默认周期为30秒，如果Eureka Server在多个心跳周期内没有接收到某个节点的心跳，Eureka Server将会从服务注册表中把这个服务节点移除(默认90秒)。</li>
</ul>
<p>Eureka Server之间通过复制的方式完成数据的同步，Eureka还提供了客户端缓存机制，即使所有的Eureka Server都挂掉，客户端依然可以利用缓存中的信息消费其他服务的API。综上，Eureka通过心跳检查、客户端缓存等机制，确保了系统的高可用性、灵活性和可伸缩性。</p>
<h3 id="服务注册与发现"><a href="#服务注册与发现" class="headerlink" title="服务注册与发现"></a>服务注册与发现</h3><p>在微服务架构中，每个微服务通常有多个实例，每个实例有不同位置，而且实例位置会动态变化。而服务注册与发现技术就是用来解决微服务开发中的这个问题</p>
<p>服务要被使用，就需要对外提供服务的位置信息，这个位置信息通常是一个IP地址+端口。在服务只有单个实例并且地址不会动态变化的情况下，服务的位置在使用端可以通过配置文件甚至代码等方式固定死。但在位置信息会动态发生变化的情况下，服务实例就需要将这个地址注册到一个注册中心。</p>
<p>服务的所有实例在自己可以对外提供服务后，将位置注册到注册中心。这个注册中心具有固定的位置或域名，负责保存所有服务实例的位置信息。</p>
<p>举个例子：</p>
<p>电商中的订单服务需要调用库存服务，但是这两个服务部署在不同的客户端，如果库存的ip地址不变，那么只需要告诉订单：我是库存，我的地址是：192.137.1.33。订单就可以调用库存服务了。<br><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200821093432.png" alt="20200821093432"></p>
<p>当库存地址发生变化时，那么又需要重新通知订单，订单需要修改库存的地址才能调用。如果库存地址经常动态变化，显而易见，将会增加很多麻烦。而服务注册中心就是用来解决这个问题。</p>
<p>在系统架构引入独立部署在一台机器上的注册中心后，订单，库存在启动时都发送请求到服务注册中心进行注册。也就是说，得告诉服务注册中心，自己是哪个服务，然后自己部署在哪台机器上。然后服务注册中心会把大家注册上来的信息放在注册表里，如下图：</p>
<p><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200821093823.png" alt="20200821093823"></p>
<p>接着订单服务假如想要调用库存服务，那么就找服务注册中心问问：能不能告诉我库存服务部署在哪台机器上？服务注册中心是知道这个信息的，所以就会告诉订单服务：库存服务部署在192.1371.133这台机器上，你就给这台机器发送请求吧。然后，订单服务就可以往库存服务的那台机器发送请求了，完成了服务间的调用。整个过程，如下图所示：<br><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200821093859.png" alt="20200821093859"></p>
<p>Zureka服务注册参考<a target="_blank" rel="noopener" href="https://www.iteye.com/blog/yangyangmyself-2334788">微服务架构中服务注册与发现</a></p>
<h3 id="Zureka使用"><a href="#Zureka使用" class="headerlink" title="Zureka使用"></a>Zureka使用</h3><div class="note info flat"><p>Zureka具体使用参考<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1jJ411S7xr?p=7">Bilibili-【狂神说Java】SpringCloud最新教程IDEA版</a></p>
</div>

<blockquote>
<p>注意：在SpringCloud Hoxton.SR7版本中server依赖为spring-cloud-starter-netflix-eureka-server</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Zureka和Zookeeper的区别"><a href="#Zureka和Zookeeper的区别" class="headerlink" title="Zureka和Zookeeper的区别"></a>Zureka和Zookeeper的区别</h3><p>先了解两个概念</p>
<blockquote>
<p>Zookeeprer : ZooKeeper是用于维护配置信息，命名，提供分布式同步以及提供组服务的集中式服务。所有这些类型的服务都以某种形式被分布式应用程序使用。每次实施它们时，都会进行很多工作来修复不可避免的错误和竞争条件。由于难以实现这类服务，因此应用程序最初通常会跳过它们，这会使它们在发生更改时变脆并且难以管理。即使部署正确，这些服务的不同实现也会导致管理复杂。</p>
<p>分布式的CAP理论：</p>
<ul>
<li>一致性（C）：在分布式系统中的所有数据备份，在同一时刻是否同样的值。（严格的一致性，所有节点访问同一份最新的数据副本）</li>
<li>可用性（A）在集群中一部分节点故障后，集群整体是否还能响应客户端的读写请求。（对数据更新具备高可用性，不保证获取的数据为最新数据，但是保证最终一致性）</li>
<li>分区容错性（P）：分布式系统在遇到任何网络分区故障的时候，仍然能够对外提供满足一致性和可用性的服务，除非整个网络环境都发生了故障。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在 C 和 A 之间做出选择。</li>
</ul>
</blockquote>
<p>CAP原则又称CAP定理，指的是在一个分布式系统中：一致性（Consistency）可用性（Availability）分区容错性（Partition tolerance）。这三个要素最多只能同时实现两点，不可能三者兼顾。</p>
<p><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200821094819.png" alt="20200821094819"></p>
<p>在分布式存储系统中，最多只能实现以上两点。而由于当前网络延迟故障会导致丢包等问题，<strong>分区容错性P在分布式系统中是必须要保证的</strong>，因此我们只能在A和C之前权衡</p>
<ul>
<li>Zookeeper保证的是CP</li>
<li>Eureka保证的是AP</li>
</ul>
<h4 id="Zookeeper保证CP"><a href="#Zookeeper保证CP" class="headerlink" title="Zookeeper保证CP"></a>Zookeeper保证CP</h4><p>当向注册中心查询服务列表时，我们可以容忍注册中心返回的是几分钟以前的注册信息，但不能接受服务直接down掉不可用。也就是说，<strong>服务注册功能对可用性的要求要高于一致性。</strong><br>但是zk会出现这样一种情况，当<strong>master节点因为网络故障与其他节点失去联系</strong>时，剩余节点会<strong>重新进行leader选举</strong>。问题在于，<strong>选举leader的时间太长</strong>，30 ~ 120s, 且<strong>选举期间整个zk集群都是不可用</strong>的，这就导致在选举期间注册服务瘫痪。<br>在云部署的环境下，因网络问题使得zk集群失去master节点是较大概率会发生的事，虽然服务能够最终恢复，但是漫长的选举时间导致的注册长期不可用是不能容忍的。</p>
<h4 id="Eureka保证AP"><a href="#Eureka保证AP" class="headerlink" title="Eureka保证AP"></a>Eureka保证AP</h4><p>Eureka看明白了这一点，因此在设计时就优先保证可用性。<strong>Eureka各个节点都是平等的</strong>，几个节点挂掉不会影响正常节点的工作，剩余的节点依然可以提供注册和查询服务。<br>而Eureka的客户端在向某个Eureka注册时如果发现连接失败，则会<strong>自动切换</strong>至其它节点，只要有一台Eureka还在，就能<strong>保证注册服务可用</strong>(保证可用性)，只不过查到的信息可能<strong>不是最新</strong>的(不保证强一致性)。<br>除此之外，Eureka还有一种<strong>自我保护机制</strong>，如果在15分钟内超过85%的节点都没有正常的心跳，那么Eureka就认为客户端与注册中心出现了网络故障，此时会出现以下几种情况：</p>
<ol>
<li>Eureka不再从注册列表中移除因为长时间没收到心跳而应该过期的服务</li>
<li>Eureka仍然能够接受新服务的注册和查询请求，但是不会被同步到其它节点上(即保证当前节点依然可用)</li>
<li>当网络稳定时，当前实例新的注册信息会被同步到其它节点中</li>
</ol>
<p>因此， Eureka可以很好的应对因网络故障导致部分节点失去联系的情况，而不会像zookeeper那样使整个注册服务瘫痪。</p>
<h2 id="Ribbon"><a href="#Ribbon" class="headerlink" title="Ribbon"></a>Ribbon</h2><h3 id="什么是Ribbon"><a href="#什么是Ribbon" class="headerlink" title="什么是Ribbon"></a>什么是Ribbon</h3><p>Spring Cloud Ribbon是一个基于HTTP和TCP的<strong>客户端负载均衡工具</strong>，它基于Netflix Ribbon实现。</p>
<p>Ribbon是Netflix发布的开源项目，主要功能是提供客户端的软件负载均衡算法，将Netflix的中间层服务连接在一起。Ribbon客户端组件提供一系列完善的配置项如连接超时，重试等。简单的说，就是在配置文件中列出Load Balancer后面所有的机器，Ribbon会自动的帮助你基于某种规则（如简单轮询，随即连接等）去连接这些机器。我们也很容易使用Ribbon实现自定义的负载均衡算法。</p>
<p>通过Spring Cloud的封装，可以让我们轻松地将面向服务的REST模版请求自动转换成客户端负载均衡的服务调用。Spring Cloud Ribbon虽然只是一个工具类框架，它不像服务注册中心、配置中心、API网关那样需要独立部署，但是它几乎存在于每一个Spring Cloud构建的微服务和基础设施中。</p>
<p>因为微服务间的调用，API网关的请求转发等内容，实际上都是通过Ribbon来实现的，包括后续介绍的Feign，它也是基于Ribbon实现的工具。所以，对Spring Cloud Ribbon的理解和使用，对于我们使用Spring Cloud来构建微服务非常重要。</p>
<h4 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h4><p>负载均衡是高可用网络基础架构的关键组件，通常用于将工作负载分布到多个服务器来提高网站、应用、数据库或其他服务的性能和可靠性。</p>
<p>一个没有负载均衡的 web 架构类似下面这样：<br><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200821115219.png" alt="20200821115219"><br>在这里用户是直连到 web 服务器，如果这个服务器宕机了，那么用户自然也就没办法访问了。另外，如果同时有很多用户试图访问服务器，超过了其能处理的极限，就会出现加载速度缓慢或根本无法连接的情况。</p>
<p>而通过在后端引入一个负载均衡器和至少一个额外的 web 服务器，可以缓解这个故障。通常情况下，所有的后端服务器会保证提供相同的内容，以便用户无论哪个服务器响应，都能收到一致的内容。<br><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200821115251.png" alt="20200821115251"></p>
<p>如图，用户访问负载均衡器，再由负载均衡器将请求转发给后端服务器。在这种情况下，单点故障现在转移到负载均衡器上了。这里又可以通过引入第二个负载均衡器来缓解。</p>
<p>负载均衡方案</p>
<p>主流的负载均衡方案分为两类：</p>
<ul>
<li><strong>集中式负载均衡</strong><ul>
<li>即在服务的消费方和提供方之间使用独立的LB设施(可以是硬件，如F5, 也可以是软件，如nginx), 由该设施负责把访问请求通过某种策略转发至服务的提供方；</li>
</ul>
</li>
<li><strong>进程内负载均衡</strong><ul>
<li>将LB逻辑集成到消费方，消费方从服务注册中心获知有哪些地址可用，然后自己再从这些地址中选择出一个合适的服务器。</li>
<li>Ribbon就属于后者，它只是一个类库，集成于消费方进程，消费方通过它来获取到服务提供方的地址。</li>
</ul>
</li>
</ul>
<h3 id="Ribbon负载均衡策略"><a href="#Ribbon负载均衡策略" class="headerlink" title="Ribbon负载均衡策略"></a>Ribbon负载均衡策略</h3><p>常用策略：</p>
<ol>
<li>RoundRobinRule：轮询</li>
<li>RandomRule：从状态为up（运行中）的服务中随机</li>
<li>AvailabilityFilteringRule：先过滤掉跳闸，访问故障的服务，再轮询</li>
<li>RetryRule：先轮询，如果服务访问失败，在指定的时间内，进行重试</li>
</ol>
<p>Ribbon策略（转）</p>
<table>
<thead>
<tr>
<th align="center">策略名</th>
<th align="center">策略声明</th>
<th align="center">策略描述</th>
<th align="center">实现说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">BestAvailableRule</td>
<td align="center">public class BestAvailableRule extends ClientConfigEnabledRoundRobinRule</td>
<td align="center">选择一个最小的并发请求的server</td>
<td align="center">逐个考察Server，如果Server被tripped了，则忽略，在选择其中ActiveRequestsCount最小的server</td>
</tr>
<tr>
<td align="center">AvailabilityFilteringRule</td>
<td align="center">public class AvailabilityFilteringRule extends PredicateBasedRule</td>
<td align="center">过滤掉那些因为一直连接失败的被标记为circuit tripped的后端server，并过滤掉那些高并发的的后端server（active connections 超过配置的阈值）</td>
<td align="center">使用一个AvailabilityPredicate来包含过滤server的逻辑，其实就就是检查status里记录的各个server的运行状态</td>
</tr>
<tr>
<td align="center">WeightedResponseTimeRule</td>
<td align="center">public class WeightedResponseTimeRule extends RoundRobinRule</td>
<td align="center">根据相应时间分配一个weight，相应时间越长，weight越小，被选中的可能性越低。</td>
<td align="center">一个后台线程定期的从status里面读取评价响应时间，为每个server计算一个weight。Weight的计算也比较简单responsetime 减去每个server自己平均的responsetime是server的权重。当刚开始运行，没有形成statas时，使用roubine策略选择server。</td>
</tr>
<tr>
<td align="center">RetryRule</td>
<td align="center">public class RetryRule extends AbstractLoadBalancerRule</td>
<td align="center">对选定的负载均衡策略机上重试机制。</td>
<td align="center">在一个配置时间段内当选择server不成功，则一直尝试使用subRule的方式选择一个可用的server</td>
</tr>
<tr>
<td align="center">RoundRobinRule</td>
<td align="center">public class RoundRobinRule extends AbstractLoadBalancerRule</td>
<td align="center">roundRobin方式轮询选择server</td>
<td align="center">轮询index，选择index对应位置的server</td>
</tr>
<tr>
<td align="center">RandomRule</td>
<td align="center">public class RandomRule extends AbstractLoadBalancerRule</td>
<td align="center">随机选择一个server</td>
<td align="center">在index上随机，选择index对应位置的server</td>
</tr>
<tr>
<td align="center">ZoneAvoidanceRule</td>
<td align="center">public class ZoneAvoidanceRule extends PredicateBasedRule</td>
<td align="center">复合判断server所在区域的性能和server的可用性选择server</td>
<td align="center">使用ZoneAvoidancePredicate和AvailabilityPredicate来判断是否选择某个server，前一个判断判定一个zone的运行性能是否可用，剔除不可用的zone（的所有server），AvailabilityPredicate用于过滤掉连接数过多的Server。</td>
</tr>
</tbody></table>
<p>同时，你也可以自定义算法策略，注意，自定义配置应放于xxxApplication.java父类同级的包下，避免被SpringBoot扫描到，从而覆盖掉之前的配置，结构如下：</p>
<p><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200821133850.png" alt="20200821133850"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将自定义负载均衡策略添加到容器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IRule <span class="title">myRule1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyRandomRule();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改后的随机策略</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRandomRule</span> <span class="keyword">extends</span> <span class="title">AbstractLoadBalancerRule</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyRandomRule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 每个服务访问5次，然后换下一个服务（一共3个）</span></span><br><span class="line">    <span class="comment">// total = 0 ，默认为0，如果total = 5，指向下一个服务节点</span></span><br><span class="line">    <span class="comment">// index = 0 ，默认为0，如果total = 5，index + 1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> total = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 被调用的次数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> currentIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 当前是谁在提供服务</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&#123;&quot;RCN_REDUNDANT_NULLCHECK_OF_NULL_VALUE&quot;&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Server <span class="title">choose</span><span class="params">(ILoadBalancer lb, Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (lb == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Server server = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (server == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                List&lt;Server&gt; upList = lb.getReachableServers();</span><br><span class="line">                <span class="comment">// 获得活着的全部服务</span></span><br><span class="line">                List&lt;Server&gt; allList = lb.getAllServers();</span><br><span class="line">                <span class="comment">// 获得全部服务</span></span><br><span class="line">                <span class="keyword">int</span> serverCount = allList.size();</span><br><span class="line">                <span class="keyword">if</span> (serverCount == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> index = <span class="keyword">this</span>.chooseRandomInt(serverCount);</span><br><span class="line">                <span class="comment">// 生成区间随机数</span></span><br><span class="line">                server = (Server) upList.get(index);</span><br><span class="line">                <span class="comment">// 从活着的服务中，随机获取一个</span></span><br><span class="line">                <span class="comment">/* ---------------- 自定义规则 -------------- */</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (total &lt; <span class="number">5</span>) &#123;</span><br><span class="line">                    server = upList.get(currentIndex);</span><br><span class="line">                    total++;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    total = <span class="number">1</span>;</span><br><span class="line">                    currentIndex++;</span><br><span class="line">                    <span class="keyword">if</span> (currentIndex &gt;= upList.size()) &#123;</span><br><span class="line">                        currentIndex = <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    server = upList.get(currentIndex);</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(total);</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* ----------------  -------------- */</span></span><br><span class="line">                <span class="keyword">if</span> (server == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Thread.yield();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (server.isAlive()) &#123;</span><br><span class="line">                        <span class="keyword">return</span> server;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    server = <span class="keyword">null</span>;</span><br><span class="line">                    Thread.yield();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> server;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">chooseRandomInt</span><span class="params">(<span class="keyword">int</span> serverCount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ThreadLocalRandom.current().nextInt(serverCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Server <span class="title">choose</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.choose(<span class="keyword">this</span>.getLoadBalancer(), key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initWithNiwsConfig</span><span class="params">(IClientConfig clientConfig)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在启动类中启动自定义策略</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Eureka和Ribbon整合以后，不用关心ip地址和端口号</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@RibbonClient(name = &quot;SPRING-CLOUD-DEPT-PROVIDER&quot;, configuration = MyRule.class)</span></span><br><span class="line"><span class="comment">// 启动自定义策略</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConsumerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Feign"><a href="#Feign" class="headerlink" title="Feign"></a>Feign</h2><h3 id="Feign简介"><a href="#Feign简介" class="headerlink" title="Feign简介"></a>Feign简介</h3><p>Feign 是声明式的服务调用工具，我们<strong>只需创建一个接口</strong>并用<strong>注解</strong>的方式来配置它，就可以实现对某个服务接口的<strong>调用</strong>，简化了直接使用 RestTemplate 来调用服务接口的开发量。Feign 具备可插拔的注解支持，同时支持 Feign 注解、JAX-RS 注解及 SpringMvc 注解。当使用 Feign 时，Spring Cloud 集成了 Ribbon 和 Eureka 以提供负载均衡的服务调用及基于 Hystrix 的服务容错保护功能。</p>
<h3 id="Feign能干什么"><a href="#Feign能干什么" class="headerlink" title="Feign能干什么"></a>Feign能干什么</h3><p>Feign旨在使编写Java Http客户端变得更容易.</p>
<p>使用Ribbon+RestTemplate时,利用RestTemplate对http请求的封装处理,形成了一套模板化的调用方法.但是在实际开发中,由于对服务依赖的调用可能不止一处,往往一个接口会被多处调用,所以通常都会针对每个微服务自行封装一些客户端类来包装这些依赖服务的调用。</p>
<p>所以,Feign在此基础上做了进一步封装,由他来帮助我们定义和实现依赖服务接口的定义.<strong>在Feign的实现下,我们只需要创建一个接口并使用注解的方式来配置它</strong>(以前是Dao接口上标注Mapper注解,现在是一个微服务接口上面标注一个Feign注解即可),<strong>即可完成对服务提供方的接口绑定</strong>,简化了使用Spring cloud Ribbon时,自动封装服务调用客户端的开发量</p>
<h3 id="Feign集成了Ribbon"><a href="#Feign集成了Ribbon" class="headerlink" title="Feign集成了Ribbon"></a>Feign集成了Ribbon</h3><p>利用Ribbon维护了MicroServiceCloud-Dept的服务列表信息,并且通过轮询实现了客户端的负载均衡。而与Ribbon不同的是,通过feign只需要定义服务绑定接口且以声明式的方法,优雅而简单的实现了服务调用。</p>
<h4 id="Feign使用"><a href="#Feign使用" class="headerlink" title="Feign使用"></a>Feign使用</h4><p>在原有consumer依赖基础上添加OpenFeign依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--启动器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--热部署--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建接口调用服务端方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;SPRING-CLOUD-DEPT-PROVIDER&quot;,fallbackFactory = MyFallBackFactory.class)</span></span><br><span class="line"><span class="comment">// value: application-服务器地址</span></span><br><span class="line"><span class="comment">// fallbackFactory: 服务降级，可以忽略</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserInfoService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// GetMappint要与将后端一致</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/userinfos&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">deleteByPrimaryKey</span><span class="params">(String userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/userinfos&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insert</span><span class="params">(UserInfo record)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/userinfos&quot;)</span></span><br><span class="line">    <span class="function">List&lt;UserInfo&gt; <span class="title">selectAll</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/userinfos&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">updateByPrimaryKey</span><span class="params">(UserInfo record)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/userinfos/&#123;phone&#125;&quot;)</span></span><br><span class="line">    <span class="function">UserInfo <span class="title">selectByPhone</span><span class="params">(<span class="meta">@PathVariable</span> String phone)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在客户端中添加Controller调用接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserInfoService userInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/userinfos/&#123;phone&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserInfo <span class="title">userinfos</span><span class="params">(<span class="meta">@PathVariable</span> String phone)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userInfoService.selectByPhone(phone);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/userinfos&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List <span class="title">userinfos</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userInfoService.selectAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加注解启动服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="comment">// 启用Erueaka</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="comment">// 启用Feign</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(FeignApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结：浏览器调用客户端Controller，然后调用客户端接口，客户端接口再调用服务端Controller。</p>
<h2 id="Hystrix"><a href="#Hystrix" class="headerlink" title="Hystrix"></a>Hystrix</h2><p>Netflix Hystrix是SOA/微服务架构中提供服务隔离、熔断、降级机制的工具/框架。Netflix Hystrix是断路器的一种实现，用于高微服务架构的可用性，是防止服务出现雪崩的利器。</p>
<p>在分布式环境中，不可避免地会有许多服务依赖项中的某些失败。Hystrix是一个库，可通过添加等待时间容限和容错逻辑来帮助您控制这些分布式服务之间的交互。Hystrix通过隔离服务之间的访问点，停止服务之间的级联故障并提供后备选项来实现此目的，所有这些都可以提高系统的整体弹性。</p>
<p>Hystrix的作用：</p>
<ul>
<li>提供保护并控制延迟和失败，以及通过第三方客户端库（通常是通过网络）访问的依赖项的失败。</li>
<li>停止复杂的分布式系统中的级联故障。</li>
<li>快速失败并快速恢复。</li>
<li>回退并在可能的情况下正常降级。</li>
<li>启用近乎实时的监视，警报和操作控制</li>
</ul>
<h3 id="Hystrix解决了什么问题"><a href="#Hystrix解决了什么问题" class="headerlink" title="Hystrix解决了什么问题"></a>Hystrix解决了什么问题</h3><p>复杂分布式体系结构中的应用程序具有数十种依赖关系，每种依赖关系不可避免地会在某个时刻失败。如果主机应用程序未与这些外部故障隔离开来，则可能会被淘汰。</p>
<p>当一个应用依赖多个外部服务，一切正常时，请求流如下：</p>
<p><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200821214756.png" alt="20200821214756"></p>
<p>多个微服务正常调用，无阻塞。</p>
<p>如果有一个服务发生延迟，当前请求就会阻塞：</p>
<p><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200821214931.png" alt="20200821214931"></p>
<p>随着高流量，单个服务延迟可能导致所有服务器上的资源在几分钟内饱和。</p>
<p>应用程序中可能会导致网络请求的，通过网络或客户端库延伸的每个点都是潜在故障的根源。比故障更糟糕的是，这些应用程序还会导致服务之间的延迟增加，从而备份队列，线程和其他系统资源，从而导致整个系统出现更多级联故障。</p>
<p><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200821215042.png" alt="20200821215042"></p>
<p>每个请求都占用了系统的CPU、内存、网络等资源，如果该应用的QPS较高，那么该应用所有的服务资源会被快速消耗完毕，直至应用死掉。如果这个出问题的依赖（Dependency I），不止这一个应用，亦或是受影响的应用上层也有更多的依赖，那就会带来服务雪崩效应。</p>
<blockquote>
<p>服务雪崩：一个服务失败，导致整个应用都崩溃。</p>
</blockquote>
<p>Hystrix提供的服务熔断和服务降级就是解决服务雪崩的手段之一</p>
<h3 id="服务熔断"><a href="#服务熔断" class="headerlink" title="服务熔断"></a>服务熔断</h3><p>服务熔断：当下游的服务因为某种原因突然变得不可用或响应过慢，上游服务为了保证自己整体服务的可用性，不再继续调用目标服务，直接返回，快速释放资源。如果目标服务情况好转则恢复调用。例如在高压电路中，如果某个地方的电压过高，熔断器就会熔断，对电路进行保护。<br>需要说明的是熔断其实是一个框架级的处理，那么这套熔断机制的设计，基本上业内用的是断路器模式，如Martin Fowler提供的状态转换图如下所示：<br><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200821215650.png" alt="20200821215650"></p>
<ul>
<li>最开始处于closed状态，一旦检测到错误到达一定阈值，便转为open状态；</li>
<li>这时候会有个 reset timeout，到了这个时间了，会转移到half open状态；</li>
<li>尝试放行一部分请求到后端，一旦检测成功便回归到closed状态，即恢复服务；</li>
</ul>
<p>在Spring Cloud框架里，熔断机制通过Hystrix实现。Hystrix会监控微服务间调用的状况，当失败的调用到一定阈值，缺省是5秒内20次调用失败，就会启动熔断机制。</p>
<p>服务熔断解决如下问题：</p>
<ol>
<li>当所依赖的对象不稳定时，能够起到快速失败的目的；</li>
<li>快速失败后，能够根据一定的算法动态试探所依赖对象是否恢复。</li>
</ol>
<h3 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h3><p>服务降级是指当服务器压力剧增的情况下，根据实际业务情况及流量，对一些服务和页面有策略的不处理或换种简单的方式处理，从而释放服务器资源以保证核心业务正常运作或高效运作。说白了，就是尽可能的把系统资源让给优先级高的服务。</p>
<p>资源有限，而请求是无限的。如果在并发高峰期，不做服务降级处理，一方面肯定会影响整体服务的性能，严重的话可能会导致宕机某些重要的服务不可用。所以，一般在高峰期，为了保证核心功能服务的可用性，都要对某些服务降级处理。例如当双11活动时，把交易无关的服务统统降级，如查看蚂蚁深林，查看历史订单等等。</p>
<p>上面是服务降级的一种情况，服务降级存在两种场景：</p>
<ul>
<li>当下游的服务因为某种原因响应过慢，下游服务主动停掉一些不太重要的业务，释放出服务器资源，增加响应速度！</li>
<li>当下游的服务因为某种原因不可用，上游主动调用本地的一些降级逻辑，避免卡顿，迅速返回给用户！</li>
</ul>
<div class="note info flat"><p>降级与熔断可以理解为：</p>
<ul>
<li>服务降级有很多种降级方式！如开关降级、限流降级、熔断降级!</li>
<li>服务熔断属于降级方式的一种！</li>
</ul>
</div>

<p>从实现上来说，熔断和降级必定是一起出现。因为当发生下游服务不可用的情况，这个时候为了对最终用户负责，就需要进入上游的降级逻辑了。因此，将熔断降级视为降级方式的一种，也是可以说的通的！</p>
<p>服务降级需要考虑以下几个问题：</p>
<ol>
<li>那些服务是核心服务，哪些服务是非核心服务</li>
<li>那些服务可以支持降级，那些服务不能支持降级，降级策略是什么</li>
<li>除服务降级之外是否存在更复杂的业务放通场景，策略是什么？</li>
</ol>
<p>自动降级分类</p>
<ul>
<li>超时降级：主要配置好超时时间和超时重试次数和机制，并使用异步机制探测回复情况</li>
<li>失败次数降级：主要是一些不稳定的api，当失败调用次数达到一定阀值自动降级，同样要使用异步机制探测回复情况</li>
<li>故障降级：比如要调用的远程服务挂掉了（网络故障、DNS故障、http服务返回错误的状态码、rpc服务抛出异常），则可以直接降级。降级后的处理方案有：默认值（比如库存服务挂了，返回默认现货）、兜底数据（比如广告挂了，返回提前准备好的一些静态页面）、缓存（之前暂存的一些缓存数据）</li>
<li>限流降级：秒杀或者抢购一些限购商品时，此时可能会因为访问量太大而导致系统崩溃，此时会使用限流来进行限制访问量，当达到限流阀值，后续请求会被降级；降级后的处理方案可以是：排队页面（将用户导流到排队页面等一会重试）、无货（直接告知用户没货了）、错误页（如活动太火爆了，稍后重试）。</li>
</ul>
<h3 id="Hystrix监控"><a href="#Hystrix监控" class="headerlink" title="Hystrix监控"></a>Hystrix监控</h3><h4 id="启用Actuator"><a href="#启用Actuator" class="headerlink" title="启用Actuator"></a>启用Actuator</h4><p>Actuator是Springboot提供的用来对应用系统进行自省和监控的功能模块，借助于Actuator开发者可以很方便地对应用系统某些监控指标进行查看、统计等。</p>
<p>若要使用Actuator对Hystrix 流进行监控，除了需在工程POM文件中引入spring-boot-starter-actuator依赖:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="启用Hystrix-Dashboard"><a href="#启用Hystrix-Dashboard" class="headerlink" title="启用Hystrix Dashboard"></a>启用Hystrix Dashboard</h4><p>使用Hystrix一个最大的好处就是它会为我们自动收集每一个HystrixCommand的信息，并利用Hystrix-Dashboard通过一种高效的方式对每一个断路器的健康状态进行展示。</p>
<p>值得注意的是，在使用HystrixCommand对RibbonClient进行包装的时候，你需要确保你配置的Hystrix超时时间要比Ribbon的超时时间长，包括由它们引起的重试时间，举个例子：如果你的Ribbon连接超时时间是1秒，并且Ribbon会连续重试请求3次，那么你的Hystrix连接超时时间需要配置成稍大于3秒。</p>
<p>使用Hystrix Dashboard需要新建一个项目作为监控页面</p>
<p>引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.16.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span><span class="comment">&lt;!--版本号自己选一个就行--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--eureka客户端--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--客户端信息--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改监控项目端口</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">9001</span></span><br></pre></td></tr></table></figure>

<p>启用监控代理并启动项目</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableHystrixDashboard</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DashBoardApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(DashBoardApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问<code>http://localhost:9001/hystrix</code>可以看到监控面板已经启动了<br><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200821222243.png" alt="20200821222243"></p>
<p>被监控项目添加一个ServletRegistrationBean。<br>注意：被监控项目需要启用熔断，并且只能监控设置了fallbackMethod的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> ServletRegistrationBean <span class="title">hystrixMetricsStreamServlet</span><span class="params">()</span></span>&#123;</span><br><span class="line">       HystrixMetricsStreamServlet streamServlet = <span class="keyword">new</span> HystrixMetricsStreamServlet();</span><br><span class="line">       ServletRegistrationBean registrationBean = <span class="keyword">new</span> ServletRegistrationBean(streamServlet);</span><br><span class="line">       registrationBean.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">       registrationBean.addUrlMappings(<span class="string">&quot;/actuator/hystrix.stream&quot;</span>);</span><br><span class="line">       registrationBean.setName(<span class="string">&quot;HystrixMetricsStreamServlet&quot;</span>);</span><br><span class="line">       <span class="keyword">return</span> registrationBean;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在我使用的Hystrix 2.2.4.RELEASE版本中需要设置允许列表</p>
<p>修改监控项目配置文件，重启项目</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">hystrix.dashboard.proxy-stream-allow-list</span>= <span class="string">*</span></span><br></pre></td></tr></table></figure>

<p>启动eureka，消费者，生产者，监控面板。</p>
<p>在消费者页面连接生产者查询数据，然后访问<code>http://localhost:生产者端口/actuator/hystrix.stream</code>可以看到数据流。例：<br><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200821222549.png" alt="20200821222549"></p>
<p>打开监控面板<code>http://localhost:9001/hystrix</code></p>
<p><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200821222826.png" alt="20200821222826"></p>
<p>输入完成后点击<code>Monitor Stream</code>就可以看到数据面板了。</p>
<p>例：<br><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200821222919.png" alt="20200821222919"></p>
<h2 id="Zuul"><a href="#Zuul" class="headerlink" title="Zuul"></a>Zuul</h2><p>Zuul是Netflix开源的微服务网关，可以和Eureka、Ribbon、Hystrix等组件配合使用。<br>Spring Cloud对Zuul进行了整合与增强，Zuul默认使用的HTTP客户端是Apache HTTPClient，也可以使用RestClient或okhttp3.OkHttpClient。<br>Zuul的主要功能是路由转发和过滤器。路由功能是微服务的一部分，比如／demo/test转发到到demo服务。zuul默认和Ribbon结合实现了负载均衡的功能</p>
<blockquote>
<p>API网关是一个服务器，是系统的唯一入口。从面向对象设计的角度看，它与外观模式类似。API网关封装了系统内部架构，为每个客户端提供一个定制的API。它可能还具有其它职责，如身份验证、监控、负载均衡、缓存、请求分片与管理、静态响应处理。<br>API网关方式的核心要点是，所有的客户端和消费端都通过统一的网关接入微服务，在网关层处理所有的非业务功能。通常，网关也是提供REST/HTTP的访问API。服务端通过API-GW注册和管理服务。</p>
</blockquote>
<h3 id="Zuul的作用"><a href="#Zuul的作用" class="headerlink" title="Zuul的作用"></a>Zuul的作用</h3><p>网关有以下几个作用：</p>
<ul>
<li>统一入口：为全部服务提供一个唯一的入口，网关起到外部和内部隔离的作用，保障了后台服务的安全性。</li>
<li>权限校验：识别每个请求的权限，拒绝不符合要求的请求。</li>
<li>动态路由：动态的将请求路由到不同的后端集群中。</li>
<li>减少客户端与服务端的耦合：服务可以独立发展，通过网关层来做映射。</li>
</ul>
<h3 id="Zuul的使用"><a href="#Zuul的使用" class="headerlink" title="Zuul的使用"></a>Zuul的使用</h3><h4 id="新建Zuul模块，添加依赖"><a href="#新建Zuul模块，添加依赖" class="headerlink" title="新建Zuul模块，添加依赖"></a>新建Zuul模块，添加依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="配置application-yml文件"><a href="#配置application-yml文件" class="headerlink" title="配置application.yml文件"></a>配置application.yml文件</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">9527</span></span><br><span class="line"><span class="comment"># 端口号</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">springcloud-zuul</span></span><br><span class="line"><span class="comment"># 组件名称</span></span><br><span class="line"></span><br><span class="line"><span class="meta">eureka.client.service-url.defaultZone</span> = <span class="string">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/</span></span><br><span class="line"><span class="comment"># eureka集群地址</span></span><br><span class="line"><span class="meta">eureka.instance.instance-id</span>=<span class="string">zuul9527.com</span></span><br><span class="line"><span class="comment"># 组件在eureka的名称</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># zuul路由配置</span></span><br><span class="line"><span class="meta">zuul.routes.SPRING-CLOUD-DEPT-PROVIDER.path</span>=<span class="string">/dept/**</span></span><br><span class="line"><span class="comment"># SPRING-CLOUD-DEPT-PROVIDER：Application，服务端名称</span></span><br><span class="line"><span class="comment"># /dept/**：路径</span></span><br></pre></td></tr></table></figure>

<p>默认路由规则：Zuul和Eureka结合使用，可以实现路由的自动配置，自动配置的路由以服务名称为匹配路径，相当于如下配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># zuul路由配置</span></span><br><span class="line"><span class="meta">zuul.routes.SPRING-CLOUD-DEPT-PROVIDER.path</span>=<span class="string">/dept/**</span></span><br><span class="line"><span class="comment"># SPRING-CLOUD-DEPT-PROVIDER：Application，服务端名称</span></span><br><span class="line"><span class="comment"># /dept/**：路径</span></span><br></pre></td></tr></table></figure>

<h4 id="添加-EnableZuulProxy注解"><a href="#添加-EnableZuulProxy注解" class="headerlink" title="添加@EnableZuulProxy注解"></a>添加@EnableZuulProxy注解</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@SpringCloudApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZoolApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ZoolApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置完成后，可以在注册中心看到Zuul已经注册了，也可以通过<code>http:localhost:9527/dept/user/1</code>调用服务端</p>
<blockquote>
<p>注意：在Zuul 2.2.4.RELEASE版本的使用中，eureka的application要转为小写，别问我怎么知道的</p>
</blockquote>
<h4 id="URL路径匹配"><a href="#URL路径匹配" class="headerlink" title="URL路径匹配"></a>URL路径匹配</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># URL pattern</span></span><br><span class="line"><span class="comment"># 使用路径方式匹配路由规则。</span></span><br><span class="line"><span class="comment"># 参数key结构： zuul.routes.customName.path=xxx</span></span><br><span class="line"><span class="comment"># 用于配置路径匹配规则。</span></span><br><span class="line"><span class="comment"># 其中customName自定义。通常使用要调用的服务名称，方便后期管理</span></span><br><span class="line"><span class="comment"># 可使用的通配符有： * ** ?</span></span><br><span class="line"><span class="comment"># ? 单个字符</span></span><br><span class="line"><span class="comment"># * 任意多个字符，不包含多级路径</span></span><br><span class="line"><span class="comment"># ** 任意多个字符，包含多级路径</span></span><br><span class="line"><span class="meta">zuul.routes.SPRING-CLOUD-DEPT-PROVIDER.path</span>=<span class="string">/api/**</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数key结构： zuul.routes.customName.url=xxx</span></span><br><span class="line"><span class="comment"># url用于配置符合path的请求路径路由到的服务地址。</span></span><br><span class="line"><span class="meta">zuul.routes.SPRING-CLOUD-DEPT-PROVIDER.url</span>=<span class="string">http://127.0.0.1:8080/</span></span><br></pre></td></tr></table></figure>

<h4 id="服务名称匹配"><a href="#服务名称匹配" class="headerlink" title="服务名称匹配"></a>服务名称匹配</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># service id pattern 通过服务名称路由</span></span><br><span class="line"><span class="comment"># key结构 ： zuul.routes.customName.path=xxx</span></span><br><span class="line"><span class="comment"># 路径匹配规则</span></span><br><span class="line"><span class="meta">zuul.routes.eureka-application-service.path</span>=<span class="string">/api/**</span></span><br><span class="line"><span class="comment"># key结构 ： zuul.routes.customName.serviceId=xxx</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># serviceId用于配置符合path的请求路径路由到的服务名称。</span></span><br><span class="line"><span class="meta">zuul.routes.eureka-application-service.serviceId</span>=<span class="string">eureka-application-service</span></span><br></pre></td></tr></table></figure>

<p>也可以使用简化配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># simple service id pattern 简化配置方案</span></span><br><span class="line"><span class="comment"># 如果只配置path，不配置serviceId。则customName相当于服务名称。</span></span><br><span class="line"><span class="comment"># 符合path的请求路径直接路由到customName对应的服务上。</span></span><br><span class="line"><span class="meta">zuul.routes.eureka-application-service.path</span>=<span class="string">/api/**</span></span><br></pre></td></tr></table></figure>

<h4 id="路由排除设置"><a href="#路由排除设置" class="headerlink" title="路由排除设置"></a>路由排除设置</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ignored service id pattern</span></span><br><span class="line"><span class="comment"># 配置不被zuul管理的服务列表。多个服务名称使用逗号&#x27;,&#x27;分隔。</span></span><br><span class="line"><span class="comment"># 配置的服务将不被zuul代理。</span></span><br><span class="line"><span class="meta">zuul.ignored-services</span>=<span class="string">eureka-application-service</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 此方式相当于给所有新发现的服务默认排除zuul网关访问方式，只有配置了路由网关的服务才可以通过zuul网关访问</span></span><br><span class="line"><span class="comment"># 通配方式配置排除列表。</span></span><br><span class="line"><span class="meta">zuul.ignored-services</span>=<span class="string">*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用服务名称匹配规则配置路由列表，相当于只对已配置的服务提供网关代理。</span></span><br><span class="line"><span class="meta">zuul.routes.eureka-application-service.path</span>=<span class="string">/api/**</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通配方式配置排除网关代理路径。所有符合ignored-patterns的请求路径都不被zuul网关代理。</span></span><br><span class="line"><span class="meta">zuul.ignored-patterns</span>=<span class="string">/**/test/**</span></span><br><span class="line"><span class="meta">zuul.routes.eureka-application-service.path</span>=<span class="string">/api/**</span></span><br></pre></td></tr></table></figure>

<h4 id="访问前缀"><a href="#访问前缀" class="headerlink" title="访问前缀"></a>访问前缀</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prefix URL pattern 前缀路由匹配</span></span><br><span class="line"><span class="comment"># 配置请求路径前缀，所有基于此前缀的请求都由zuul网关提供代理。</span></span><br><span class="line"><span class="meta">zuul.prefix</span>=<span class="string">/api</span></span><br><span class="line"><span class="comment"># 使用服务名称匹配方式配置请求路径规则。</span></span><br><span class="line"><span class="comment"># 这里的配置将为：http://ip:port/api/appservice/**的请求提供zuul网关代理，可以将要访问服务进行前缀分类。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 并将请求路由到服务eureka-application-service中。</span></span><br><span class="line"><span class="meta">zuul.routes.eureka-application-service.path</span>=<span class="string">/appservice/**</span></span><br></pre></td></tr></table></figure>

<p>如上，配置访问前缀需要在路由前添加前缀才能访问，例：<code>http://localhost:9527/proxy/dept/userinfos/1</code>访问。</p>
<p>zuul网关其底层使用ribbon来实现请求的路由，并内置Hystrix，可选择性提供网关fallback逻辑。使用zuul的时候，并不推荐使用Feign作为application client端的开发实现。毕竟Feign技术是对ribbon的再封装，使用Feign本身会提高通讯消耗，降低通讯效率，</p>
<h2 id="SpringCloud-Config"><a href="#SpringCloud-Config" class="headerlink" title="SpringCloud  Config"></a>SpringCloud  Config</h2><p>分布式系统中，为了方便服务配置文件统一管理，实时更新，所以需要分布式配置中心组件。在Spring Cloud中，有分布式配置中心组件springCloud Config ，它支持从远程Git仓库中读取配置文件并存放到本地Git仓库。</p>
<p>备注：这是整个模块最简单的项目，简而言之就是将配置文件上传到git仓库，项目再从git获取并初始化项目。SpringCloud Config是C-S结构的。</p>
<h3 id="Config-Server"><a href="#Config-Server" class="headerlink" title="Config-Server"></a>Config-Server</h3><p>创建一个git仓库，这一步就不介绍了。直接开始项目搭建</p>
<h4 id="添加Config依赖"><a href="#添加Config依赖" class="headerlink" title="添加Config依赖"></a>添加Config依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- config启动器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="配置Server配置文件"><a href="#配置Server配置文件" class="headerlink" title="配置Server配置文件"></a>配置Server配置文件</h4><p>创建application.yml文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 端口号</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3344</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="comment"># 项目名</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">com.xqm.springcloud-config-server</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="comment"># git仓库地址，注意是https</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://gitee.com/xshiming/com.xqm.springcloud-config.git</span></span><br></pre></td></tr></table></figure>

<h4 id="启动Server"><a href="#启动Server" class="headerlink" title="启动Server"></a>启动Server</h4><p>添加注解<code>@EnableConfigServer</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConfigServer.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只需要三步就可以迅速搭建一个服务端，接下来看项目中如何获取配置文件。</p>
<h3 id="Config-Client"><a href="#Config-Client" class="headerlink" title="Config-Client"></a>Config-Client</h3><p>在仓库新建一个Config-Client文件，内容就是你接下用到的项目的配置，例：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"> <span class="attr">profiles:</span></span><br><span class="line">  <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"> <span class="attr">port:</span> <span class="number">8181</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"> <span class="attr">profiles:</span> <span class="string">dev</span></span><br><span class="line"> <span class="attr">application :</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">springcloud-provider-dept</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"> <span class="attr">port:</span> <span class="number">8182</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"> <span class="attr">profiles:</span> <span class="string">test</span></span><br><span class="line"> <span class="attr">application :</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">springcloud-provider-dept</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/</span></span><br></pre></td></tr></table></figure>

<p>将文件上传git仓库，就可以在<code>http://localhost:3344/config-client-dev.yml</code>访问到刚才配置的文件中的dev环境配置</p>
<p>访问规则：</p>
<ul>
<li>/{application}/{profile}[/{label}] 例：<code>http://localhost:3344/config-client/dev/master</code></li>
<li>/{application}-{profile}.yml 例：<code>http://localhost:3344/config-client-dev.yml</code></li>
<li>/{label}/{application}-{profile}.yml 例：<code>http://localhost:3344/master/config-client-dev.yml</code></li>
<li>/{application}-{profile}.properties</li>
<li>/{label}/{application}-{profile}.properties</li>
</ul>
<h4 id="添加客户端依赖"><a href="#添加客户端依赖" class="headerlink" title="添加客户端依赖"></a>添加客户端依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="修改客户端配置文件"><a href="#修改客户端配置文件" class="headerlink" title="修改客户端配置文件"></a>修改客户端配置文件</h4><p>在resources目录下新建<code>bootstrap.yml</code>文件，</p>
<blockquote>
<p>注：bootstrap.yml是系统配置，application.yml是个人配置，会被前者覆盖</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 系统级别配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:3344</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config-client</span> <span class="comment"># 需要从git上读取的资源名称，不需要后缀</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line">     <span class="comment"># 即 http://localhost:3344/config-client/dev/master</span></span><br></pre></td></tr></table></figure>

<p>如上，两步就配置完成了。</p>
<p>测试一个属性取到没有</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigClientController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.application.name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String applicationName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;eureka.client.service-url.defaultZone&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String eurekaServer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/config&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">config</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;applicationName : &quot;</span>+applicationName+<span class="string">&quot; eurekaServer : &quot;</span>+eurekaServer+<span class="string">&quot; port : &quot;</span>+port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动项目访问<code>http://localhost:8182/config</code>能看到返回了刚才配置的值。大功告成</p>
<h2 id="SpringCloud总结"><a href="#SpringCloud总结" class="headerlink" title="SpringCloud总结"></a>SpringCloud总结</h2><ul>
<li>微服务</li>
<li>SpringCluod</li>
<li>Netflix<ul>
<li>Eureka</li>
<li>Ribbon</li>
<li>Feign</li>
<li>Zuul</li>
<li>Hystrix</li>
</ul>
</li>
<li>SpringCloud Config</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/av76020761?p=17">【狂神说Java】SpringCloud最新教程IDEA版</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/u013982921/article/details/93622716?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.edu_weight&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.edu_weight">Consul服务注册与服务发现机制</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/snowjeblog/p/8821325.html">Eureka的工作原理以及它与ZooKeeper的区别</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jing99/p/11696192.html">SpringCloud之Zuul网关原理及其配置</a></li>
<li><a target="_blank" rel="noopener" href="https://www.springcloud.cc/">Spring Cloud中文网</a></li>
</ul>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">失铭</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://shiming.best/blog/96a41905/">https://shiming.best/blog/96a41905/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://shiming.best" target="_blank">失铭的学习笔记</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Spring/">Spring</a><a class="post-meta__tags" href="/tags/SpringCloud/">SpringCloud</a></div><div class="post_share"><div class="social-share" data-image="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200821223213.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/blog/88650203/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">POI和EasyExcel</div></div></a></div><div class="next-post pull-right"><a href="/blog/20547/"><img class="next-cover" src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200808180623.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Spring+Mybatis+Druid</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/blog/38008/" title="Maven"><img class="cover" src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200808180554.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-23</div><div class="title">Maven</div></div></a></div><div><a href="/blog/55715/" title="Servlet"><img class="cover" src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/guidao/pic-108.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-23</div><div class="title">Servlet</div></div></a></div><div><a href="/blog/3a66a386/" title="Session和Cookie"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-08-14</div><div class="title">Session和Cookie</div></div></a></div><div><a href="/blog/4780/" title="SpringMVC"><img class="cover" src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/guidao/pic-87.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-23</div><div class="title">SpringMVC</div></div></a></div><div><a href="/blog/56612/" title="SSM搭建"><img class="cover" src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/guidao/pic-82.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-23</div><div class="title">SSM搭建</div></div></a></div><div><a href="/blog/20547/" title="Spring+Mybatis+Druid"><img class="cover" src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200808180623.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-08-20</div><div class="title">Spring+Mybatis+Druid</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/null" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">失铭</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">60</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">39</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">微服务概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.1.</span> <span class="toc-text">什么是微服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-number">1.2.</span> <span class="toc-text">微服务优缺点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%A0%88"><span class="toc-number">1.3.</span> <span class="toc-text">微服务技术栈</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Cloud"><span class="toc-number">2.</span> <span class="toc-text">Spring Cloud</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-Cloud-%E7%89%88%E6%9C%AC"><span class="toc-number">2.1.</span> <span class="toc-text">Spring Cloud 版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringBoot%E5%92%8CSpringCloud%E5%85%B3%E7%B3%BB"><span class="toc-number">2.2.</span> <span class="toc-text">SpringBoot和SpringCloud关系</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dubbo"><span class="toc-number">3.</span> <span class="toc-text">Dubbo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Dubbo%E5%92%8CSpringCluod%E5%8C%BA%E5%88%AB"><span class="toc-number">3.1.</span> <span class="toc-text">Dubbo和SpringCluod区别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Zureka"><span class="toc-number">4.</span> <span class="toc-text">Zureka</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0"><span class="toc-number">4.1.</span> <span class="toc-text">服务注册与发现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zureka%E4%BD%BF%E7%94%A8"><span class="toc-number">4.2.</span> <span class="toc-text">Zureka使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zureka%E5%92%8CZookeeper%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">4.3.</span> <span class="toc-text">Zureka和Zookeeper的区别</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Zookeeper%E4%BF%9D%E8%AF%81CP"><span class="toc-number">4.3.1.</span> <span class="toc-text">Zookeeper保证CP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Eureka%E4%BF%9D%E8%AF%81AP"><span class="toc-number">4.3.2.</span> <span class="toc-text">Eureka保证AP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ribbon"><span class="toc-number">5.</span> <span class="toc-text">Ribbon</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFRibbon"><span class="toc-number">5.1.</span> <span class="toc-text">什么是Ribbon</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">5.1.1.</span> <span class="toc-text">负载均衡</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="toc-number">5.2.</span> <span class="toc-text">Ribbon负载均衡策略</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Feign"><span class="toc-number">6.</span> <span class="toc-text">Feign</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Feign%E7%AE%80%E4%BB%8B"><span class="toc-number">6.1.</span> <span class="toc-text">Feign简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Feign%E8%83%BD%E5%B9%B2%E4%BB%80%E4%B9%88"><span class="toc-number">6.2.</span> <span class="toc-text">Feign能干什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Feign%E9%9B%86%E6%88%90%E4%BA%86Ribbon"><span class="toc-number">6.3.</span> <span class="toc-text">Feign集成了Ribbon</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Feign%E4%BD%BF%E7%94%A8"><span class="toc-number">6.3.1.</span> <span class="toc-text">Feign使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hystrix"><span class="toc-number">7.</span> <span class="toc-text">Hystrix</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Hystrix%E8%A7%A3%E5%86%B3%E4%BA%86%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98"><span class="toc-number">7.1.</span> <span class="toc-text">Hystrix解决了什么问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD"><span class="toc-number">7.2.</span> <span class="toc-text">服务熔断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span class="toc-number">7.3.</span> <span class="toc-text">服务降级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hystrix%E7%9B%91%E6%8E%A7"><span class="toc-number">7.4.</span> <span class="toc-text">Hystrix监控</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E7%94%A8Actuator"><span class="toc-number">7.4.1.</span> <span class="toc-text">启用Actuator</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E7%94%A8Hystrix-Dashboard"><span class="toc-number">7.4.2.</span> <span class="toc-text">启用Hystrix Dashboard</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Zuul"><span class="toc-number">8.</span> <span class="toc-text">Zuul</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Zuul%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">8.1.</span> <span class="toc-text">Zuul的作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zuul%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">8.2.</span> <span class="toc-text">Zuul的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E5%BB%BAZuul%E6%A8%A1%E5%9D%97%EF%BC%8C%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="toc-number">8.2.1.</span> <span class="toc-text">新建Zuul模块，添加依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEapplication-yml%E6%96%87%E4%BB%B6"><span class="toc-number">8.2.2.</span> <span class="toc-text">配置application.yml文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0-EnableZuulProxy%E6%B3%A8%E8%A7%A3"><span class="toc-number">8.2.3.</span> <span class="toc-text">添加@EnableZuulProxy注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#URL%E8%B7%AF%E5%BE%84%E5%8C%B9%E9%85%8D"><span class="toc-number">8.2.4.</span> <span class="toc-text">URL路径匹配</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%90%8D%E7%A7%B0%E5%8C%B9%E9%85%8D"><span class="toc-number">8.2.5.</span> <span class="toc-text">服务名称匹配</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E6%8E%92%E9%99%A4%E8%AE%BE%E7%BD%AE"><span class="toc-number">8.2.6.</span> <span class="toc-text">路由排除设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E5%89%8D%E7%BC%80"><span class="toc-number">8.2.7.</span> <span class="toc-text">访问前缀</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringCloud-Config"><span class="toc-number">9.</span> <span class="toc-text">SpringCloud  Config</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Config-Server"><span class="toc-number">9.1.</span> <span class="toc-text">Config-Server</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0Config%E4%BE%9D%E8%B5%96"><span class="toc-number">9.1.1.</span> <span class="toc-text">添加Config依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEServer%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">9.1.2.</span> <span class="toc-text">配置Server配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8Server"><span class="toc-number">9.1.3.</span> <span class="toc-text">启动Server</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Config-Client"><span class="toc-number">9.2.</span> <span class="toc-text">Config-Client</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BE%9D%E8%B5%96"><span class="toc-number">9.2.1.</span> <span class="toc-text">添加客户端依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">9.2.2.</span> <span class="toc-text">修改客户端配置文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringCloud%E6%80%BB%E7%BB%93"><span class="toc-number">10.</span> <span class="toc-text">SpringCloud总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">11.</span> <span class="toc-text">参考</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/blog/f37f1f3f/" title="MySQL练习"><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200808175918.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL练习"/></a><div class="content"><a class="title" href="/blog/f37f1f3f/" title="MySQL练习">MySQL练习</a><time datetime="2020-09-18T16:00:00.000Z" title="发表于 2020-09-19 00:00:00">2020-09-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/e55dcfb0/" title="行为型模式"><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/background/background-10.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="行为型模式"/></a><div class="content"><a class="title" href="/blog/e55dcfb0/" title="行为型模式">行为型模式</a><time datetime="2020-08-30T09:48:18.000Z" title="发表于 2020-08-30 17:48:18">2020-08-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/8f9f2030/" title="创造型模式"><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/background/background-10.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="创造型模式"/></a><div class="content"><a class="title" href="/blog/8f9f2030/" title="创造型模式">创造型模式</a><time datetime="2020-08-30T09:48:18.000Z" title="发表于 2020-08-30 17:48:18">2020-08-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/620ff0b5/" title="结构型模式"><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/background/background-10.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="结构型模式"/></a><div class="content"><a class="title" href="/blog/620ff0b5/" title="结构型模式">结构型模式</a><time datetime="2020-08-30T09:48:18.000Z" title="发表于 2020-08-30 17:48:18">2020-08-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/4c5df410/" title="HTTP和HTTPS的区别"><img src="https://xqm-oss.oss-cn-beijing.aliyuncs.com/blog/20200828171626.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="HTTP和HTTPS的区别"/></a><div class="content"><a class="title" href="/blog/4c5df410/" title="HTTP和HTTPS的区别">HTTP和HTTPS的区别</a><time datetime="2020-08-27T16:00:00.000Z" title="发表于 2020-08-28 00:00:00">2020-08-28</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 By 失铭</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>